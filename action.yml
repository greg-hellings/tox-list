name: Tox List
description: >-
  Runs 'tox -l' on your repository and sets the output to a JSON list of environments
inputs:
  tox-args:
    descrition: Additional CLI arguments to tox
    required: true
    default: ''
outputs:
  tox-envs:
    description: A JSON list of tox environments
    value: ${{ steps.envs.outputs.envs }}
runs:
  using: composite
  steps:
    - name: Run tox with args and get output
      id: envs
      shell: bash
      run: |
        set -ex -o pipefail
        if ! command -v tox;
        then
          # Destination for the virtualenv
          if [ "${RUNNER_OS}" == "Windows" ];
          then
            venv="${{ github.action_path }}\\venv"
            activate="${venv}\\bin\\activate"
          else
            venv="${{ github.action_path }}/venv"
            activate="${venv}/bin/activate"
          fi

          # Create the virtualenv
          if [ "${RUNNER_OS}" == "Windows" ];
          then
            python -m venv "${venv}"
          else
            python3 -m venv "${venv}"
          fi

          # Activate the virtualenv
          if [ "${RUNNER_OS}" == "Windows" ];
          then
            ls -R "${venv}"
          else
            source "${activate}"
          fi

          # Install tox
          python -m pip install tox
        fi
        envs="$(tox -ql ${{ inputs.tox-args }} | python -c 'import sys; import json; print(json.dumps(sys.stdin.read().strip().split("\n")))')"
        echo "::set-output name=envs::${envs}"
